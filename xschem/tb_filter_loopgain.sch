v {xschem version=3.4.5 file_version=1.2
}
G {}
K {}
V {}
S {}
E {}
N 1000 -240 1000 -220 {
lab=vout1}
N 330 -630 330 -590 {
lab=vcmi}
N 330 -530 330 -490 {
lab=vcmi}
N 410 -560 410 -540 {
lab=vcmi}
N 410 -480 410 -460 {
lab=GND}
N 330 -430 330 -360 {
lab=vin}
N 330 -760 330 -690 {
lab=vip}
N 250 -640 290 -640 {
lab=GND}
N 250 -640 250 -440 {
lab=GND}
N 250 -440 290 -440 {
lab=GND}
N 220 -480 290 -480 {
lab=#net1}
N 220 -680 220 -480 {
lab=#net1}
N 220 -680 290 -680 {
lab=#net1}
N 170 -680 170 -590 {
lab=#net1}
N 170 -680 220 -680 {
lab=#net1}
N 170 -530 170 -410 {
lab=GND}
N 170 -440 250 -440 {
lab=GND}
N 130 -540 130 -510 {
lab=GND}
N 130 -510 170 -510 {
lab=GND}
N 10 -580 10 -540 {
lab=vid}
N 10 -580 130 -580 {
lab=vid}
N 10 -480 10 -410 {
lab=GND}
N 530 -600 540 -600 {
lab=vip}
N 530 -520 540 -520 {
lab=vin}
N 600 -600 610 -600 {
lab=vipp}
N 600 -520 610 -520 {
lab=vinn}
N 330 -590 330 -530 {
lab=vcmi}
N 680 -600 710 -600 {
lab=vcmi}
N 710 -610 710 -600 {
lab=vcmi}
N 710 -610 730 -610 {
lab=vcmi}
N 680 -520 710 -520 {
lab=vcmi}
N 710 -520 710 -510 {
lab=vcmi}
N 710 -510 730 -510 {
lab=vcmi}
N 840 -740 840 -710 {
lab=voutn1}
N 980 -740 980 -710 {
lab=voutn1}
N 940 -610 980 -610 {
lab=vr_n}
N 980 -650 980 -610 {
lab=vr_n}
N 940 -510 980 -510 {
lab=vr_p}
N 980 -510 980 -470 {
lab=vr_p}
N 840 -410 840 -380 {
lab=voutp1}
N 840 -380 1160 -380 {
lab=voutp1}
N 980 -410 980 -380 {
lab=voutp1}
N 840 -740 1160 -740 {
lab=voutn1}
N 930 -210 960 -210 {
lab=voutp1}
N 930 -170 960 -170 {
lab=voutn1}
N 1230 -240 1230 -220 {
lab=vout}
N 1160 -210 1190 -210 {
lab=voutp2}
N 1160 -170 1190 -170 {
lab=voutn2}
N 330 -760 490 -760 {
lab=vip}
N 330 -360 490 -360 {
lab=vin}
N 330 -560 410 -560 {
lab=vcmi}
N 490 -520 490 -360 {
lab=vin}
N 490 -520 530 -520 {
lab=vin}
N 490 -600 530 -600 {
lab=vip}
N 490 -760 490 -600 {
lab=vip}
N 1000 -160 1000 -130 {
lab=GND}
N 1230 -160 1230 -130 {
lab=GND}
N 980 -620 990 -610 {
lab=vr_n}
N 980 -500 990 -510 {
lab=vr_p}
N 840 -530 840 -470 {
lab=#net2}
N 840 -650 840 -590 {
lab=#net3}
N 790 -610 830 -610 {
lab=#net3}
N 830 -610 840 -620 {
lab=#net3}
N 840 -600 850 -610 {
lab=#net3}
N 850 -610 880 -610 {
lab=#net3}
N 790 -510 830 -510 {
lab=#net2}
N 830 -510 840 -520 {
lab=#net2}
N 840 -500 850 -510 {
lab=#net2}
N 850 -510 880 -510 {
lab=#net2}
N 680 -600 680 -520 {
lab=vcmi}
N 760 -240 760 -220 {
lab=vr}
N 690 -210 720 -210 {
lab=vr_p}
N 690 -170 720 -170 {
lab=vr_n}
N 760 -160 760 -130 {
lab=GND}
N 1100 -420 1120 -420 {
lab=vinn}
N 1100 -430 1100 -420 {
lab=vinn}
N 1100 -510 1100 -490 {
lab=vi_opa_n}
N 1100 -510 1130 -510 {
lab=vi_opa_n}
N 1100 -630 1100 -610 {
lab=vi_opa_p}
N 1100 -610 1130 -610 {
lab=vi_opa_p}
N 1100 -700 1120 -700 {
lab=vipp}
N 1100 -700 1100 -690 {
lab=vipp}
N 990 -610 1010 -610 {
lab=vr_n}
N 1070 -610 1100 -610 {
lab=vi_opa_p}
N 990 -510 1010 -510 {
lab=vr_p}
N 1070 -510 1100 -510 {
lab=vi_opa_n}
N 1160 -380 1250 -380 {
lab=voutp1}
N 1160 -740 1250 -740 {
lab=voutn1}
N 1360 -450 1360 -430 {
lab=GND}
N 1130 -610 1180 -610 {
lab=vi_opa_p}
N 1130 -510 1180 -510 {
lab=vi_opa_n}
N 1250 -380 1770 -380 {
lab=voutp1}
N 1250 -740 1770 -740 {
lab=voutn1}
N 410 -560 680 -560 {
lab=vcmi}
N 1180 -610 1220 -610 {
lab=vi_opa_p}
N 1220 -610 1220 -600 {
lab=vi_opa_p}
N 1180 -510 1220 -510 {
lab=vi_opa_n}
N 1220 -520 1220 -510 {
lab=vi_opa_n}
N 1490 -600 1620 -600 {
lab=vo_opa_n}
N 1490 -520 1620 -520 {
lab=vo_opa_p}
N 1680 -600 1770 -600 {
lab=voutn1}
N 1770 -740 1770 -600 {
lab=voutn1}
N 1680 -520 1770 -520 {
lab=voutp1}
N 1770 -520 1770 -380 {
lab=voutp1}
N 1770 -520 1830 -520 {
lab=voutp1}
N 1770 -600 1830 -600 {
lab=voutn1}
N 420 -250 420 -220 {
lab=VDD}
N 420 -160 420 -130 {
lab=GND}
N 420 -260 420 -250 {
lab=VDD}
N 500 -160 500 -130 {
lab=GND}
N 500 -260 500 -220 {
lab=di_pon}
N 1360 -680 1360 -660 {
lab=VDD}
N 1320 -670 1320 -660 {
lab=di_pon}
N 1970 -600 2090 -600 {
lab=voutp2}
N 1970 -520 2090 -520 {
lab=voutn2}
N 2090 -650 2090 -600 {
lab=voutp2}
N 2090 -520 2090 -470 {
lab=voutn2}
N 1830 -600 1860 -520 {
lab=voutn1}
N 1860 -520 1910 -520 {
lab=voutn1}
N 1830 -520 1860 -600 {
lab=voutp1}
N 1860 -600 1910 -600 {
lab=voutp1}
N 2010 -600 2010 -590 {
lab=voutp2}
N 2010 -530 2010 -520 {
lab=voutn2}
C {devices/vsource.sym} 410 -510 0 0 {name=V2 value=0.9
}
C {devices/vcvs.sym} 330 -460 0 0 {name=E1 value=0.5}
C {devices/vcvs.sym} 330 -660 0 0 {name=E2 value=0.5}
C {devices/vsource.sym} 10 -510 0 0 {name=VIN value="0 AC 1"
}
C {devices/lab_pin.sym} 330 -760 0 0 {name=l1 sig_type=std_logic lab=vip}
C {devices/lab_pin.sym} 330 -360 0 0 {name=l1 sig_type=std_logic lab=vin
}
C {devices/lab_pin.sym} 410 -560 1 0 {name=l3 sig_type=std_logic lab=vcmi}
C {devices/launcher.sym} 130 -120 0 0 {name=h1
descr="Annotate OP"
tclcommand="set show_hidden_texts 1; xschem annotate_op"}
C {sky130_fd_pr/corner.sym} 170 -260 0 0 {name=CORNER only_toplevel=false corner=tt}
C {devices/lab_pin.sym} 10 -580 1 0 {name=l1 sig_type=std_logic lab=vid}
C {devices/lab_pin.sym} 1000 -240 0 1 {name=l1 sig_type=std_logic lab=vout1}
C {devices/gnd.sym} 10 -410 0 0 {name=l1 lab=GND}
C {devices/code.sym} 40 -260 0 0 {name=STIMULI
only_toplevel=false
value="
*.include /foss/designs/filter/ota_casc_3_dev_save.spice
.options savecurrents
.options method=gear reltol=.01
.options sparse
.control
save all

let f_sig = 100
let f_min = 10
let f_max = 100G
let f_stop = 5Meg
let tper_sig = 1/f_sig
let tfr_sig = tper_sig/2
let Adc = 10
let beta = 1/Adc
let v_step_o = 0.9
let v_step_i = v_step_o/Adc

let t_rf = 0.1u
let t_step = 50u
let t_delay = 0
let t_per = 2*t_step

let tstep = 0.1*t_rf
let tstop = 2*t_per
let tstart = t_delay

*alter @VIN[SIN] = [ 0 0.01 $&f_sig 0 0 0 ]
alter @VIN[DC] = 0.0


*set fndc = /foss/designs/frontend/frontend_dc.txt
*set fntran = /foss/designs/frontend/frontend_tran.txt
*set fnspec = /foss/designs/frontend/frontend_spec.txt
*set fnhd = /foss/designs/frontend/frontend_hd.txt
*set fnnoise = /foss/designs/frontend/frontend_noise.txt
set wr_singlescale
set wr_vecnames
option numdgt=3


** Main Simulations
	op
	ac dec 100 $&const.f_min $&const.f_max
	
	setplot ac1
	let A1 = v(vout1)/v(vid)
	let A2 = v(vout)/v(vid)
	let L = v(vr)/v(vid)
	let A = L/beta

	let L_re = real(L)
	let L_im = imag(L)
	
	let L_dB = vdb(L)
	let L_arg = 180/PI*cphase(L)
	let A_dB = vdb(A)
	let A_arg = 180/PI*cphase(A)

	let fdc = const.f_min+1
	
	meas ac fug find frequency when L_dB=0
	meas ac pm find L_arg when frequency=fug
	
	let pm = 180-abs(pm)

	print pm

	let err_gain = 1-10^(Adc/20)/10
	let Adc_ol_min = (1-err_gain)/err_gain

	print err_gain
	print Adc_ol_min
	
	plot L_dB L_arg A_dB A_arg title 'Bode Plot of Loop Gain' ylabel 'Magnitude (dB) / Phase (Deg)'
	plot L_im vs L_re retraceplot title 'Nyquist Plot of Loop Gain' ylabel 'Imaginary Part' xlabel 'Real Part' 


alter @VIN[DC] = 0
op

remzerovec
write tb_filter_loopgain.raw
.endc"}
C {devices/gnd.sym} 410 -460 0 0 {name=l14 lab=GND}
C {devices/vcvs.sym} 170 -560 0 0 {name=E3 value=1}
C {devices/gnd.sym} 170 -410 0 0 {name=l15 lab=GND}
C {devices/vcvs.sym} 1000 -190 0 0 {name=E4 value=1}
C {devices/gnd.sym} 1000 -130 0 0 {name=l18 lab=GND}
C {devices/title.sym} 160 -40 0 0 {name=l22 author="Michael Koefinger"}
C {devices/lab_pin.sym} 610 -600 1 0 {name=p3 sig_type=std_logic lab=vipp}
C {devices/lab_pin.sym} 610 -520 3 0 {name=p4 sig_type=std_logic lab=vinn}
C {devices/vsource.sym} 570 -600 3 0 {name=VIINP value=0
}
C {devices/vsource.sym} 570 -520 3 0 {name=VIINN value=0
}
C {devices/res.sym} 760 -610 3 0 {name=R1
value=650k
footprint=1206
device=resistor
m=1}
C {devices/lab_pin.sym} 930 -170 2 1 {name=l5 sig_type=std_logic lab=voutn1}
C {devices/lab_pin.sym} 930 -210 0 0 {name=l6 sig_type=std_logic lab=voutp1
}
C {devices/res.sym} 840 -680 0 0 {name=R2
value=1.3Meg
footprint=1206
device=resistor
m=1}
C {devices/res.sym} 910 -610 3 0 {name=R3
value=100k
footprint=1206
device=resistor
m=1}
C {devices/capa.sym} 980 -680 0 0 {name=C1
m=1
value=1p
footprint=1206
device="ceramic capacitor"}
C {devices/capa.sym} 840 -560 0 0 {name=C3
m=1
value=20p
footprint=1206
device="ceramic capacitor"}
C {devices/res.sym} 760 -510 3 0 {name=R11
value=650k
footprint=1206
device=resistor
m=1}
C {devices/res.sym} 840 -440 0 0 {name=R21
value=1.3Meg
footprint=1206
device=resistor
m=1}
C {devices/res.sym} 910 -510 3 0 {name=R31
value=100k
footprint=1206
device=resistor
m=1}
C {devices/capa.sym} 980 -440 0 0 {name=C5
m=1
value=1p
footprint=1206
device="ceramic capacitor"}
C {devices/lab_pin.sym} 1770 -440 2 0 {name=l10 sig_type=std_logic lab=voutp1
}
C {devices/lab_pin.sym} 1770 -670 0 1 {name=l11 sig_type=std_logic lab=voutn1
}
C {devices/lab_pin.sym} 1230 -240 0 1 {name=l12 sig_type=std_logic lab=vout}
C {devices/vcvs.sym} 1230 -190 0 0 {name=E5 value=1}
C {devices/gnd.sym} 1230 -130 0 0 {name=l13 lab=GND}
C {devices/lab_pin.sym} 1160 -170 2 1 {name=l19 sig_type=std_logic lab=voutn2
}
C {devices/lab_pin.sym} 1160 -210 0 0 {name=l23 sig_type=std_logic lab=voutp2
}
C {devices/vsource.sym} 1650 -600 3 0 {name=VIOP value=0
}
C {devices/vsource.sym} 1650 -520 3 1 {name=VION value=0
}
C {devices/lab_pin.sym} 760 -240 0 1 {name=l4 sig_type=std_logic lab=vr}
C {devices/vcvs.sym} 760 -190 0 0 {name=E6 value=1}
C {devices/gnd.sym} 760 -130 0 0 {name=l8 lab=GND}
C {devices/lab_pin.sym} 690 -170 2 1 {name=l9 sig_type=std_logic lab=vr_n
}
C {devices/lab_pin.sym} 690 -210 0 0 {name=l20 sig_type=std_logic lab=vr_p

}
C {devices/lab_pin.sym} 990 -510 3 0 {name=l21 sig_type=std_logic lab=vr_p

}
C {devices/lab_pin.sym} 990 -610 3 1 {name=l24 sig_type=std_logic lab=vr_n
}
C {devices/lab_pin.sym} 1120 -420 2 0 {name=p1 sig_type=std_logic lab=vinn}
C {devices/lab_pin.sym} 1120 -700 2 0 {name=p2 sig_type=std_logic lab=vipp}
C {devices/capa.sym} 1100 -460 0 0 {name=C7
m=1
value=1G
footprint=1206
device="ceramic capacitor"}
C {devices/capa.sym} 1100 -660 0 0 {name=C8
m=1
value=1G
footprint=1206
device="ceramic capacitor"}
C {devices/ind.sym} 1040 -510 1 0 {name=L25
m=1
value=1G
footprint=1206
device=inductor}
C {devices/ind.sym} 1040 -610 1 0 {name=L28
m=1
value=1G
footprint=1206
device=inductor}
C {devices/gnd.sym} 1360 -430 0 0 {name=l30 lab=GND}
C {devices/lab_pin.sym} 1180 -610 3 0 {name=p7 sig_type=std_logic lab=vi_opa_p}
C {devices/lab_pin.sym} 1180 -510 3 0 {name=p8 sig_type=std_logic lab=vi_opa_n}
C {devices/lab_pin.sym} 1560 -600 1 0 {name=p9 sig_type=std_logic lab=vo_opa_n}
C {devices/lab_pin.sym} 1560 -520 3 0 {name=p10 sig_type=std_logic lab=vo_opa_p}
C {/foss/designs/amp.sym} 1180 -740 0 0 {name=xamp1}
C {devices/vsource.sym} 420 -190 0 0 {name=V3 value=1.8
}
C {devices/gnd.sym} 420 -130 0 0 {name=l2 lab=GND}
C {devices/vdd.sym} 420 -260 0 0 {name=l7 lab=VDD}
C {devices/vsource.sym} 500 -190 0 0 {name=V4 value=1.8
}
C {devices/gnd.sym} 500 -130 0 0 {name=l33 lab=GND}
C {devices/lab_pin.sym} 500 -260 1 0 {name=p61 sig_type=std_logic lab=di_pon}
C {devices/vdd.sym} 1360 -680 0 0 {name=l26 lab=VDD}
C {devices/lab_pin.sym} 1320 -670 1 0 {name=p5 sig_type=std_logic lab=di_pon}
C {devices/lab_pin.sym} 2090 -650 1 0 {name=l27 sig_type=std_logic lab=voutp2
}
C {devices/lab_pin.sym} 2090 -470 1 1 {name=l29 sig_type=std_logic lab=voutn2
}
C {devices/capa.sym} 2010 -560 0 0 {name=C4
m=1
value=1p
footprint=1206
device="ceramic capacitor"}
C {devices/res.sym} 1940 -600 3 0 {name=R5
value=800k
footprint=1206
device=resistor
m=1}
C {devices/res.sym} 1940 -520 3 0 {name=R6
value=800k
footprint=1206
device=resistor
m=1}
